### 文件名称: `modeling_chatglm.py`

#### 对代码的解读

这个文件包含了对聊天生成语言模型（ChatGLM）的建模。以下是其中的一些重要部分：

- `InvalidScoreLogitsProcessor`类：这是一个对数值进行处理的类，如果输入的分数中存在NaN或者inf，会将其替换为指定值，这里是将其全部替换为5e4。

- `PrefixEncoder`类：这个类用于对输入的前缀进行编码。它根据配置决定是否进行前缀的投影。如果进行投影，则使用一个两层的MLP来编码前缀，否则直接使用Embedding层。这里的编码主要是为了提供给模型更多的上下文信息。

- `RotaryEmbedding`类：这个类实现了旋转位置编码。它在Transformer的基础上增加了旋转位置编码的功能，通过增加了一定的位置偏移量，来提升模型对位置信息的建模能力。

- `RMSNorm`类：这是一个自定义的归一化层。它根据输入的隐藏状态计算均值，并使用该均值对隐藏状态进行归一化处理。

- `CoreAttention`类：这个类实现了Transformer中的注意力机制。它根据输入的查询、键和值，以及注意力掩码，计算出上下文张量。在计算过程中，使用了缩放点积注意力（Scaled Dot-Product Attention）的方式来计算注意力得分，并且支持了多头注意力。